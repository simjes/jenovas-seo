---
import Hosts from "@/components/Hosts.astro";
import Layout from "@/components/Layout.astro";
import PodcastLinks from "@/components/PodcastLinks.astro";
import SpotifyEmbedEpisode from "@/components/SpotifyEmbedEpisode.astro";
import { authors, slugify } from "@/lib/meta";
import { getEpisodeDetails, getShowDetails } from "@/lib/spotify";
import { formatDate, formatDuration } from "@/lib/time";
import { Schema } from "astro-seo-schema";

export async function getStaticPaths() {
	const showDetails = await getShowDetails();
	const totalEpisodes = showDetails.total_episodes;

	return showDetails.episodes.items.map((entry, index) => ({
		params: { slug: slugify(entry.name) },
		props: { id: entry.id, episodeNumber: totalEpisodes - index },
	}));
}

const { id, episodeNumber } = Astro.props;
const episodeDetails = await getEpisodeDetails(id);
---

<Layout>
	<Fragment slot="head">
		<meta name="description" content={episodeDetails.description} />
		<meta property="og:title" content={episodeDetails.name} />
		<meta property="og:description" content={episodeDetails.description} />
		<meta property="og:image" content={episodeDetails.images[0].url} />
		<meta property="og:type" content="website" />
		<meta property="og:url" content={Astro.url.toString()} />
		<meta name="twitter:card" content="summary_large_image" />
		<meta name="twitter:title" content={episodeDetails.name} />
		<meta name="twitter:description" content={episodeDetails.description} />
		<meta name="twitter:image" content={episodeDetails.images[0].url} />
		<!-- TODO: astro-seo -->
		<meta name="twitter:site" content="@rad_crew" />
		<meta name="twitter:creator" content="@rad_crew" />
		<meta name="twitter:creator" content="@arodem" />
		<meta name="twitter:creator" content="@MuffensKarl" />
		<title>{episodeDetails.name}</title>

		<Schema
			item={{
				"@context": "https://schema.org",
				"@type": "PodcastEpisode",
				name: episodeDetails.name,
				description: episodeDetails.description,
				episodeNumber,
				image: episodeDetails.images[0].url,
				url: Astro.site?.toString(), // TODO: Url of the item -> spotify?
				datePublished: episodeDetails.release_date,
				duration: `PT${Math.floor(episodeDetails.duration_ms / 60000)}M`,
				associatedMedia: {
					"@type": "AudioObject",
					contentUrl: episodeDetails.audio_preview_url,
				},
				partOfSeries: {
					"@type": "PodcastSeries",
					name: episodeDetails.show.name,
					url: episodeDetails.show.external_urls.spotify,
				},
				author: authors,
			}}
		/>
	</Fragment>

	<article class="prose max-w-3xl mx-auto px-4 py-8">
		<a
			href="/"
			class="inline-block mb-4 text-blue-600 hover:text-blue-800 transition-colors"
		>
			&larr; Tilbake til hovedsiden
		</a>

		<h1 class="text-3xl font-bold mb-4">{episodeDetails.name}</h1>
		<SpotifyEmbedEpisode title={episodeDetails.name} id={id} />

		<div class="mt-6">
			<p class="text-sm text-gray-600">
				Utgitt {formatDate(episodeDetails.release_date)}
				â€¢ {formatDuration(episodeDetails.duration_ms)}
			</p>
			<div class="mt-4">{episodeDetails.description}</div>
		</div>

		{
			episodeDetails.explicit && (
				<p class="mt-4 text-red-600 font-semibold">
					Denne episoden inneholder eksplisitt innhold.
				</p>
			)
		}
	</article>
	<PodcastLinks />
	<Hosts />
</Layout>
